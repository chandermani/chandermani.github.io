---
layout: post
title: Appharbor build notification using Google Talk (XMPP) - Implementation
date: '2012-09-16T16:12:00.001+05:30'
author: Chandermani Arora
tags:
- Appharbor
- XMPP
- notifications
- webapi
- Azure
- Architecture
- Google Talk
modified_time: '2012-09-16T16:12:08.021+05:30'
thumbnail: http://1.bp.blogspot.com/-jCQ7ARSQM2g/UFWo2OxQLLI/AAAAAAAAAhw/oJoH3Y6C61I/s72-c/AppharborbotArch.png
blogger_id: tag:blogger.com,1999:blog-20117988.post-7749832793953382080
blogger_orig_url: http://chandermani.blogspot.com/2012/09/appharbor-build-notification-using.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">In my <a href="http://chandermani.blogspot.in/2012/07/appharbor-build-notification-using.html" target="_blank">last post</a> about creating an Appharbor notification bot, I described about the problem domain, the solution approaches and how the end to end scenario works.This post would dig deeper into the implementation aspects of the solution.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">To start with we need to understand the two esential ingredients for this recipe </div><ul style="text-align: left;"><li style="text-align: justify;"><b><a href="https://appharbor.com/page/how-it-works" target="_blank">Appharbor Service hooks</a>:</b> Appharbor Service hooks are the building block for the solution. Appharbor provides capability, where it can post to any public url with status of a build on completion. Service hooks are available for events </li><ul><li>Build Success.</li><li>Build failure.</li></ul></ul><ul style="text-align: justify;"><li><a href="http://xmpp.org/" target="_blank"><b>XMPP protocol</b></a>: XMPP is a protocol used for Instant Messaging (IM) communication. It allows us to relay messages to the users IM client using XMPP servers (in our case Google Talk messaging servers).</li></ul><br /><div style="text-align: justify;">With the understanding on these two concept we are ready to dive into the nitty gritty&nbsp; of the solution.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Assuming that the user did the initial configurations to setup notifications (see my <a href="http://chandermani.blogspot.in/2012/07/appharbor-build-notification-using.html" target="_blank">earlier post</a>), here is what happens behind the scenes when a build notification is triggered from Appharbor</div><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-jCQ7ARSQM2g/UFWo2OxQLLI/AAAAAAAAAhw/oJoH3Y6C61I/s1600/AppharborbotArch.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-jCQ7ARSQM2g/UFWo2OxQLLI/AAAAAAAAAhw/oJoH3Y6C61I/s1600/AppharborbotArch.png" /></a></div><div class="separator" style="clear: both; text-align: left;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div>One may find it odd that parts of the solution are hosted on AppHarbor and parts on Windows Azure worker role.<br /><br /><div style="text-align: justify;">The reason for this was, inability for IIS to host the XMPP client and allow it to keep persistent connections to XMPP server. Whenever i was trying to instantiate a XMPP client (<a href="http://www.ag-software.de/agsxmpp-sdk/" target="_blank">agsXMPP</a>) the call silently failed when hosted in IIS. In a console app it worked fine. I did not dwell much into the issue but based on my initial research the XMPP client tries to create a persistent connection to XMPP server (in our case Google Talk) but IIS does not allow this.</div><br /><div style="text-align: justify;">Since AppHarbor provide more of a web endpoint (presumably in IIS) the solution did not work when hosted in AppHarbor(even in Azure webrole). I had to create a Azure Worker Role and expose a web endpoint from the worker role. Using <a href="http://www.asp.net/web-api" target="_blank">ASP.Net Web API</a> <a href="http://www.asp.net/web-api/overview/hosting-aspnet-web-api/self-host-a-web-api" target="_blank">Self hosted</a> feature, I was able to host a http endpoint within the worker role, but it did require some configuration changes for the worker role.&nbsp; </div><br /><div style="text-align: justify;">To know more about the implementation details look at the source code available on <a href="https://github.com/chandermani/AppharborBot" target="_blank">GitHub</a>.&nbsp;</div>Project <i>Appharborbot.Webhost</i> contains the bot web site code.<br />Project <i>Apphraborbot.Worker</i> contains the Azure worker role code.<br /><br />Overall this was an interesting exercise which showed how multiple technology\tools can be combined to create a quick n smart solution. <br /><br /><br /><br /></div>
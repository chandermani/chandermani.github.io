---
layout: post
title: Integrate ELMAH with WCF and Azure
date: '2010-11-29T22:14:00.016+05:30'
author: Chandermani Arora
tags:
- Azure
- ELMAH
- WCF
- Integration
modified_time: '2010-12-16T17:13:36.759+05:30'
blogger_id: tag:blogger.com,1999:blog-20117988.post-4570936568106517872
blogger_orig_url: http://chandermani.blogspot.com/2010/11/i-recently-integrated-elmah-error.html
---

<div  style="text-align: justify;font-family:trebuchet ms;"><span style="font-size:100%;">I recently integrated <a href="http://www.raboof.com/projects/Elmah/">ELMAH </a>(Error Logging Modules and Handlers) with our Azure application. ELMAH is an <a href="http://www.hanselman.com/blog/ELMAHErrorLoggingModulesAndHandlersForASPNETAndMVCToo.aspx">excellent error logging and reporting libary</a> available for ASP.Net. We used ELMAH for logging all unhandled service exceptions in WCF and ASP.Net. While there is information available on internet about how to integrate these technologies, data is scattered in bits and pieces. My aim through this blog post is to details the steps required for integration.<br /></span></div><span style=";font-family:trebuchet ms;font-size:100%;"  ><br /></span><div  style="text-align: justify;font-family:trebuchet ms;"><span style="font-size:100%;">The scenario of usage is, we wanted to log all unhandled exception thrown by our WCF service layer in a database which in our case was SQL Azure. Once done we could easily navigate to the the elmah default url to get a nice report on what errors were being generated by the application. Had it been a typical ASP.Net application, integrating ELMAH is a piece of cake. But since we were working on a Azure web deployment with SQL Azure as the backend some tweaks were necessary. Here are the things to do to get  ELMAH fully functional in an Azure deployment<br /><br /></span></div><ol  style="font-family:trebuchet ms;"><li><span style="font-size:100%;"><span style="font-weight: bold;">Download Binaries</span> : Start with downloading the binaries from the google source code repository <a href="http://code.google.com/p/elmah/">here</a> and add it to your solution project.</span></li><li><span style="font-weight: bold;">Install ELMAH SQL Script</span>: The default SQL script that is part of the download does not work directly with SQL Azure DB. I have updated the script and am adding it to the end of post.<br /></li><li><span style="font-size:100%;"><span style="font-weight: bold;">Implement IErrorHandler</span>: Since WCF itself does not have a common\single point failure catching mechanism like ASP.Net (global.asax ApplicationError event) we need to implement one. The IErrorHandler approach is a perfect fit for this situation. Check <a href="http://www.neovolve.com/post/2008/04/07/implementing-ierrorhandler.aspx">this post</a> for better understanding the approach. It involved<br /></span></li><ol><li><span style="font-size:100%;">Writing an implementation for IErrorHandler and IServiceBehaviour.</span></li><li><span style="font-size:100%;">Implementing the method ProvideFault which would log the error using ELMAH. This method is called everytime an error occurs.<br /></span><br /><pre class="brush:csharp" style="display: none;">public void ProvideFault(Exception error, System.ServiceModel.Channels.MessageVersion version, ref System.ServiceModel.Channels.Message fault)<br />     {<br />         if (error != null &amp;&amp; HttpContext.Current != null) // Notify ELMAH of the exception.<br />         {<br />             try<br />             {<br />                 Elmah.ErrorSignal.FromCurrentContext().Raise(error);<br />             }<br />             catch (Exception loggerException)<br />             {<br />                 //If failed to log with ELMAH trace it.<br />                 System.Diagnostics.Trace.TraceError(error.GetDetails());<br />                 System.Diagnostics.Trace.TraceError(loggerException.GetDetails());<br />             }<br />         }<br />         return;<br />     }</pre><br /></li><li><span style="font-size:100%;">Add other custom code to implement the IServiceBehaviour.<br /></span></li><li><span style="font-size:100%;">Since we wanted config file support we also implemented a custom BehaviorExtensionElement.</span></li><li><span style="font-size:100%;">The complete implementation is available as downlad at the end of the blog post.<br /></span></li></ol><li><span style="font-size:100%;"><span style="font-weight: bold;">Cofigure ELMAH</span> : ELMAH by default is configure to store errors in memory which i don't think is terribly useful. To configure SQL Server integration we need to<br /></span></li><ol><li><span style="font-size:100%;">Add configuration section declaration for ElMAH in web.config</span><br /><pre class="brush:xml">&lt;configSections&gt;<br />      &lt;sectionGroup name="elmah"&gt;<br />          &lt;section name="errorLog" requirePermission="false" type="Elmah.ErrorLogSectionHandler, Elmah" /&gt;<br />      &lt;/sectionGroup&gt;<br />  &lt;/configSections&gt;</pre><br /></li><li><span style="font-size:100%;">Add configuration section for ELMAH. Remember to provide a valid connection string in the settings. This connectionstring value will not be user which i will detail later.</span><br /><pre class="brush:xml">&lt;elmah&gt;<br />      &lt;errorLog type="ELMAHIntegration.ELMAHSQLErrorLog,ELMAHIntegration" connectionString="[Dummy Connection String]"/&gt;<br />  &lt;/elmah&gt;</pre><br /></li><li><span style="font-size:100%;">Note the type used in this configuration (ELMAHSQLErrorLog) is not the default type that comes with the library. I have attached code for this class too.<br /></span></li></ol><li><span style="font-size:100%;"><span style="font-weight: bold;">Integrate ELMAH settings with Azure configuration</span> : The problem with Connection string defined in web.config for an Azure deployment is that it is not consistent with Azure's own configuration . Azure uses a cscfg file to store application level settings whereas ELMAH is configured to pick connectionstring from web.config, What we want is to pick connectionstring defined in Azure cscfg file. This is where we use the magic of inheritance to change ELMAH behaviour in terms of selecting connection string.<br /></span></li><ol><li><span style="font-size:100%;">Create a class ELMAHSQLErrorLog which derives from Elmah.SQLErrorLog class and overrides its ConnectionString property.<br /></span><pre class="brush:csharp">public override string ConnectionString<br />        {<br />            get<br />            {<br />                if (RoleEnvironment.IsAvailable)<br />                {<br />                    return RoleEnvironment.GetConfigurationSettingValue(ErrorLoggerConnectionStringConfigKey);<br />                }<br />                else<br />                {<br />                    return ConfigurationManager.ConnectionStrings[ErrorLoggerConnectionStringConfigKey].ConnectionString;<br />                }<br /><br />            }<br />        }</pre><br /></li><li><span style="font-size:100%;">Reference this class in relevant section in the web.config file (See step 3)</span></li></ol><li><span style="font-size:100%;">Voila !!! now ELMAH should start logging data in SQL Azure database.<br /></span></li></ol><span style=";font-family:trebuchet ms;font-size:100%;"  >Hope this post helps everyone integrate ELMAH in their WCF/Azure project. The code files mentioned in this walk through can be downloaded from this <a href="https://docs.google.com/leaf?id=0B59ctf4e17gZZWM1NmFkYTgtMjE0Mi00MjAwLTkzMGEtYzNhY2NhYmUyZDgx&amp;hl=en">location</a>.<br /><br />Happy Coding,<br />Chandermani<br /><br /></span>